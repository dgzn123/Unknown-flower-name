#include "stm32f10x.h"
#include "Buzzer.h"
#include "Delay.h"
#include "OLED.h"

typedef struct {
	float time;
	float freq;
} Note;

Note music[] = {
	{0.34, 278.79},
	{0.35, 270.85},
	{0.43, 285.30},
	{0.45, 314.74},
	{0.48, 347.22},
	{0.52, 372.14},
	{0.59, 367.86},
	{0.62, 316.57},
	{0.63, 307.55},
	{0.66, 327.73},
	{0.73, 412.91},
	{0.74, 422.56},
	{0.85, 415.30},
	{0.95, 417.71},
	{1.22, 468.86},
	{1.31, 466.16},
	{1.36, 468.86},
	{1.42, 466.16},
	{1.54, 468.86},
	{1.56, 466.16},
	{1.71, 468.86},
	{1.75, 466.16},
	{1.83, 412.91},
	{1.95, 417.71},
	{2.11, 471.58},
	{2.25, 466.16},
	{2.58, 415.30},
	{2.59, 417.71},
	{2.77, 468.86},
	{2.91, 466.16},
	{3.08, 415.30},
	{3.20, 417.71},
	{3.27, 415.30},
	{3.36, 417.71},
	{3.56, 415.30},
	{3.70, 417.71},
	{3.97, 415.30},
	{4.03, 417.71},
	{4.35, 369.99},
	{4.39, 372.14},
	{4.60, 417.71},
	{4.62, 415.30},
	{4.89, 369.99},
	{5.05, 372.14},
	{5.14, 369.99},
	{5.25, 374.29},
	{5.27, 367.86},
	{5.50, 372.14},
	{5.77, 369.99},
	{5.87, 374.29},
	{5.93, 369.99},
	{6.28, 372.14},
	{6.62, 277.18},
	{6.66, 278.79},
	{6.68, 277.18},
	{6.72, 280.40},
	{6.79, 277.18},
	{6.84, 278.79},
	{6.91, 277.18},
	{6.99, 278.79},
	{7.08, 275.59},
	{7.19, 282.03},
	{7.50, 277.18},
	{7.52, 278.79},
	{7.53, 277.18},
	{7.59, 280.40},
	{7.63, 318.40},
	{7.65, 351.25},
	{7.79, 372.14},
	{7.99, 417.71},
	{8.10, 415.30},
	{8.12, 425.01},
	{8.16, 415.30},
	{8.22, 417.71},
	{8.37, 468.86},
	{8.49, 463.48},
	{8.51, 468.86},
	{8.54, 466.16},
	{8.60, 468.86},
	{8.72, 466.16},
	{8.81, 468.86},
	{8.87, 466.16},
	{9.06, 468.86},
	{9.07, 466.16},
	{9.08, 468.86},
	{9.29, 466.16},
	{9.45, 477.06},
	{9.49, 466.16},
	{9.71, 567.32},
	{10.16, 466.16},
	{10.18, 468.86},
	{10.27, 463.48},
	{10.47, 471.58},
	{10.75, 466.16},
	{10.94, 468.86},
	{11.03, 466.16},
	{11.05, 468.86},
	{11.16, 466.16},
	{11.23, 415.30},
	{11.31, 417.71},
	{11.37, 415.30},
	{11.63, 367.86},
	{11.71, 372.14},
	{11.80, 437.47},
	{11.91, 415.30},
	{11.92, 417.71},
	{11.94, 415.30},
	{11.95, 420.13},
	{12.10, 471.58},
	{12.17, 466.16},
	{12.26, 468.86},
	{12.32, 466.16},
	{12.65, 468.86},
	{12.70, 466.16},
	{12.97, 468.86},
	{13.04, 466.16},
	{13.40, 468.86},
	{13.49, 466.16},
	{13.53, 468.86},
	{13.58, 466.16},
	{13.70, 468.86},
	{14.11, 72.15},
	{14.78, 427.47},
	{14.79, 415.30},
	{14.95, 417.71},
	{15.06, 471.58},
	{15.12, 466.16},
	{15.42, 415.30},
	{15.63, 367.86},
	{15.70, 372.14},
	{15.95, 365.74},
	{16.21, 372.14},
	{16.59, 369.99},
	{16.60, 372.14},
	{16.75, 369.99},
	{17.07, 372.14},
	{17.09, 369.99},
	{17.16, 372.14},
	{17.21, 369.99},
	{17.40, 372.14},
	{17.46, 369.99},
	{17.57, 183.93},
	{18.38, 420.13},
	{18.40, 415.30},
	{18.56, 417.71},
	{18.67, 468.86},
	{18.77, 466.16},
	{19.13, 369.99},
	{19.14, 372.14},
	{19.20, 369.99},
	{19.28, 372.14},
	{19.37, 367.86},
	{19.77, 372.14},
	{19.83, 369.99},
	{19.98, 372.14},
	{19.99, 369.99},
	{20.51, 372.14},
	{20.70, 124.19},
	{41.24, 316.57},
	{41.29, 347.22},
	{41.33, 372.14},
	{41.68, 361.54},
	{41.73, 372.14},
	{41.83, 369.99},
	{41.90, 383.04},
	{42.12, 369.99},
	{42.36, 372.14},
	{42.50, 367.86},
	{42.85, 335.39},
	{42.88, 293.66},
	{42.90, 270.85},
	{42.98, 282.03},
	{43.06, 277.18},
	{43.08, 278.79},
	{43.10, 277.18},
	{43.11, 278.79},
	{43.80, 277.18},
	{43.84, 278.79},
	{44.03, 374.29},
	{44.28, 367.86},
	{44.37, 372.14},
	{44.38, 369.99},
	{44.41, 372.14},
	{44.76, 369.99},
	{44.79, 372.14},
	{44.80, 369.99},
	{44.95, 372.14},
	{45.49, 369.99},
	{45.69, 376.46},
	{45.80, 369.99},
	{45.89, 312.93},
	{45.99, 380.84},
	{46.05, 369.99},
	{46.35, 333.46},
	{46.38, 304.02},
	{46.41, 266.20},
	{46.54, 278.79},
	{46.70, 277.18},
	{46.71, 280.40},
	{46.82, 275.59},
	{46.85, 278.79},
	{46.90, 314.74},
	{47.33, 277.18},
	{47.35, 278.79},
	{47.37, 277.18},
	{47.60, 367.86},
	{47.66, 372.14},
	{47.96, 367.86},
	{48.03, 372.14},
	{48.45, 369.99},
	{48.84, 372.14},
	{49.15, 369.99},
	{49.21, 372.14},
	{49.26, 429.95},
	{49.33, 415.30},
	{49.40, 417.71},
	{49.45, 415.30},
	{49.50, 353.29},
	{49.52, 335.39},
	{49.55, 300.53},
	{49.60, 272.42},
	{49.82, 278.79},
	{50.05, 275.59},
	{50.12, 278.79},
	{50.17, 277.18},
	{50.18, 283.66},
	{50.69, 277.18},
	{50.72, 278.79},
	{50.78, 277.18},
	{51.26, 278.79},
	{51.33, 277.18},
	{51.39, 278.79},
	{51.51, 312.93},
	{51.66, 311.13},
	{52.00, 312.93},
	{52.01, 309.34},
	{52.13, 312.93},
	{52.16, 311.13},
	{52.31, 312.93},
	{52.50, 79.14},
	{55.39, 374.29},
	{55.52, 365.74},
	{55.68, 372.14},
	{56.05, 369.99},
	{56.15, 372.14},
	{56.25, 369.99},
	{56.65, 372.14},
	{56.74, 369.99},
	{56.78, 372.14},
	{56.94, 369.99},
	{57.14, 339.29},
	{57.17, 304.02},
	{57.28, 277.18},
	{57.34, 290.29},
	{57.46, 277.18},
	{57.54, 280.40},
	{58.12, 274.00},
	{58.13, 278.79},
	{58.19, 264.67},
	{58.68, 378.64},
	{58.75, 369.99},
	{58.96, 374.29},
	{59.08, 369.99},
	{59.28, 374.29},
	{59.66, 369.99},
	{59.76, 372.14},
	{60.04, 333.46},
	{60.06, 345.22},
	{60.16, 372.14},
	{60.28, 369.99},
	{60.31, 372.14},
	{60.41, 369.99},
	{60.44, 339.29},
	{60.45, 341.25},
	{60.46, 376.46},
	{60.50, 367.86},
	{60.70, 339.29},
	{60.73, 305.78},
	{60.89, 272.42},
	{60.96, 280.40},
	{61.03, 275.59},
	{61.10, 278.79},
	{61.18, 274.00},
	{62.28, 380.84},
	{62.39, 369.99},
	{62.62, 372.14},
	{62.73, 367.86},
	{62.84, 372.14},
	{63.25, 369.99},
	{63.31, 372.14},
	{63.32, 369.99},
	{63.39, 372.14},
	{63.44, 369.99},
	{63.59, 447.69},
	{63.65, 415.30},
	{63.73, 417.71},
	{63.92, 286.96},
	{63.95, 274.00},
	{65.93, 312.93},
	{65.94, 311.13},
	{66.06, 312.93},
	{66.08, 311.13},
	{66.20, 277.18},
	{66.29, 282.03},
	{66.35, 312.93},
	{66.41, 311.13},
	{66.50, 314.74},
	{66.59, 311.13},
	{66.66, 312.93},
	{66.75, 305.78},
	{67.13, 312.93},
	{68.15, 78.23},
	{84.67, 417.71},
	{84.69, 412.91},
	{84.83, 417.71},
	{85.17, 70.10},
	{88.11, 278.79},
	{88.14, 277.18},
	{88.18, 278.79},
	{88.28, 275.59},
	{88.34, 278.79},
	{88.47, 275.59},
	{91.81, 403.48},
	{91.96, 417.71},
	{92.08, 468.86},
	{92.32, 70.10},
	{93.20, 314.74},
	{93.38, 291.97},
	{93.44, 314.74},
	{93.56, 288.62},
	{93.62, 316.57},
	{93.65, 372.14},
	{93.72, 417.71},
	{94.17, 91.97},
	{97.14, 278.79},
	{97.19, 318.40},
	{97.21, 363.64},
	{97.25, 372.14},
	{97.38, 367.86},
	{97.40, 337.33},
	{97.41, 341.25},
	{97.45, 440.00},
	{97.50, 415.30},
	{97.55, 417.71},
	{97.61, 415.30},
	{97.81, 70.51},
	{133.60, 312.93},
	{133.69, 311.13},
	{133.89, 312.93},
	{134.01, 311.13},
	{134.10, 320.24},
	{134.58, 264.67},
	{134.63, 282.03},
	{134.88, 312.93},
	{135.00, 311.13},
	{135.05, 275.59},
	{135.08, 278.79},
	{135.13, 277.18},
	{135.14, 282.03},
	{135.26, 314.74},
	{135.31, 311.13},
	{135.33, 312.93},
	{135.35, 311.13},
	{135.36, 312.93},
	{135.37, 311.13},
	{135.45, 312.93},
	{135.47, 311.13},
	{135.50, 316.57},
	{135.53, 347.22},
	{135.87, 327.73},
	{135.88, 309.34},
	{136.01, 312.93},
	{136.15, 341.25},
	{136.43, 295.37},
	{136.46, 312.93},
	{136.58, 387.49},
	{136.59, 367.86},
	{137.04, 337.33},
	{137.09, 345.22},
	{137.38, 376.46},
	{137.46, 369.99},
	{137.76, 412.91},
	{137.81, 369.99},
	{137.97, 372.14},
	{138.09, 369.99},
	{138.23, 257.13},
	{138.32, 278.79},
	{138.43, 277.18},
	{138.57, 278.79},
	{138.63, 277.18},
	{138.86, 297.08},
	{138.87, 277.18},
	{138.97, 278.79},
	{139.10, 277.18},
	{139.12, 278.79},
	{139.18, 275.59},
	{139.26, 322.10},
	{139.34, 311.13},
	{139.45, 312.93},
	{139.48, 311.13},
	{139.55, 277.18},
	{139.68, 278.79},
	{139.78, 312.93},
	{139.87, 311.13},
	{140.00, 312.93},
	{140.14, 138.59},
	{140.64, 282.03},
	{140.89, 312.93},
	{140.93, 311.13},
	{140.96, 312.93},
	{141.24, 311.13},
	{141.29, 312.93},
	{141.42, 186.07},
	{141.84, 298.80},
	{141.97, 316.57},
	{142.20, 311.13},
	{142.34, 275.59},
	{142.42, 282.03},
	{142.48, 314.74},
	{142.70, 359.46},
	{142.88, 333.46},
	{142.90, 347.22},
	{143.15, 327.73},
	{143.31, 347.22},
	{143.74, 378.64},
	{143.75, 357.39},
	{144.03, 339.29},
	{144.11, 311.13},
	{144.15, 339.29},
	{144.16, 355.33},
	{144.70, 372.14},
	{144.75, 369.99},
	{144.78, 372.14},
	{144.94, 365.74},
	{145.18, 372.14},
	{145.22, 369.99},
	{145.39, 372.14},
	{145.45, 369.99},
	{145.60, 372.14},
	{146.56, 187.15},
	{147.35, 417.71},
	{147.45, 415.30},
	{147.53, 417.71},
	{147.63, 468.86},
	{147.70, 463.48},
	{147.90, 415.30},
	{148.10, 367.86},
	{148.13, 372.14},
	{148.22, 369.99},
	{148.53, 325.84},
	{148.60, 309.34},
	{148.64, 316.57},
	{148.71, 307.55},
	{148.76, 312.93},
	{149.13, 425.01},
	{149.19, 415.30},
	{149.30, 417.71},
	{149.39, 471.58},
	{149.47, 458.16},
	{149.59, 403.48},
	{149.65, 417.71},
	{149.88, 365.74},
	{149.98, 372.14},
	{150.18, 69.70},
	{151.00, 415.30},
	{151.12, 417.71},
	{151.46, 415.30},
	{151.64, 369.99},
	{151.80, 372.14},
	{151.96, 369.99},
	{152.16, 251.26},
	{152.32, 278.79},
	{152.33, 275.59},
	{152.38, 278.79},
	{152.57, 277.18},
	{152.69, 278.79},
	{152.71, 277.18},
	{152.72, 280.40},
	{152.90, 277.18},
	{153.22, 278.79},
	{153.45, 327.73},
	{153.50, 311.13},
	{153.70, 312.93},
	{153.72, 311.13},
	{153.88, 277.18},
	{153.99, 278.79},
	{154.49, 460.81},
	{154.69, 468.86},
	{154.99, 427.47},
	{155.10, 415.30},
	{155.20, 417.71},
	{155.23, 415.30},
	{155.31, 417.71},
	{155.35, 415.30},
	{155.56, 369.99},
	{155.62, 323.96},
	{155.63, 309.34},
	{155.69, 318.40},
	{155.78, 311.13},
	{155.85, 312.93},
	{155.91, 311.13},
	{156.31, 378.64},
	{156.47, 417.71},
	{156.57, 468.86},
	{156.63, 466.16},
	{156.79, 408.17},
	{156.90, 417.71},
	{156.99, 415.30},
	{157.04, 365.74},
	{157.06, 372.14},
	{157.16, 369.99},
	{157.23, 372.14},
	{157.30, 369.99},
	{157.48, 302.27},
	{157.68, 347.22},
	{157.70, 316.57},
	{157.90, 311.13},
	{157.91, 318.40},
	{157.98, 311.13},
	{157.99, 312.93},
	{158.04, 311.13},
	{158.07, 316.57},
	{158.13, 387.49},
	{158.33, 417.71},
	{158.34, 415.30},
	{158.88, 369.99},
	{159.80, 372.14},
	{160.02, 369.99},
	{160.06, 372.14},
	{160.11, 369.99},
	{160.12, 372.14},
	{160.16, 369.99},
	{160.22, 372.14},
	{160.23, 369.99},
	{160.24, 372.14},
	{160.26, 369.99},
	{160.48, 140.20},
	{161.49, 293.66},
	{161.51, 277.18},
	{161.58, 282.03},
	{161.67, 327.73},
	{161.68, 361.54},
	{161.74, 372.14},
	{161.91, 417.71},
	{162.03, 415.30},
	{162.34, 65.41}
};

int main(void)
{
	Buzzer_Init();
	
	uint16_t len = sizeof(music) / sizeof(Note);
	// 计算每个音符的持续时间并播放
	for (int i = 0; i < len; i++)			// 循环：遍历每个音符
	{
		uint16_t freq = (uint16_t)music[i].freq;		// 获取当前音符的频率
		float duration_sec;
		
		if (i < len - 1)		// 不是最后一个音符
		{
			duration_sec = music[i+1].time - music[i].time;		// 计算持续时间（秒）
		}
		else
		{
			duration_sec = 1.0; // 最后音符持续时间
		}
		
		// 如果持续时间很长（例如 > 2 秒），则可能是中断
        // 播放该音符一小段时间（例如 500 毫秒，或者如果更短，则直到下一个音符），然后静音
		if (duration_sec > 2.0)
		{
			Buzzer_Set(freq, 50);  	// 播放音符，50% 占空比
			Delay_ms(500); // 0.5s
			Buzzer_Set(0, 0); // 静默
			Delay_ms((uint32_t)((duration_sec - 0.5) * 1000));   	// 静默剩余时间
		}
		else
		{
			Buzzer_Set(freq, 50);   // 播放音符
			Delay_ms((uint32_t)(duration_sec * 1000));		// 持续时间
		}
	}
	
	Buzzer_Set(0, 0);  	// 停止蜂鸣器
	
	while(1)
	{
		
	}
}
